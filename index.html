<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Παρακολούθηση Προφίλ Υποψηφίων (με Όριο Προσλήψεων)</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics/fonts - Tailwind utility classes will handle the rest */
        body {
            font-family: 'Inter', sans-serif;
        }
        .candidate-input {
            transition: all 0.2s ease-in-out;
        }
        .status-select {
            /* Basic styling for status selection */
            color: #1f2937; /* Dark text */
            background-color: #ffffff;
            border: 1px solid #d1d5db;
        }
        /* Color coding based on status */
        .status-NoStatus { border-left-color: #f59e0b; } /* Amber */
        .status-Interviewing { border-left-color: #3b82f6; } /* Blue */
        .status-Accepted { border-left-color: #10b981; } /* Emerald */
        .status-Rejected { border-left-color: #ef4444; } /* Red */
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">
    <div id="app-container" class="max-w-6xl mx-auto">
        <header class="mb-8 border-b pb-4 border-blue-200">
            <h1 class="text-3xl md:text-4xl font-extrabold text-blue-700">
                Παρακολούθηση Προφίλ Υποψηφίων
            </h1>
            <p id="auth-status" class="text-sm text-gray-500 mt-1">Αρχικοποίηση...</p>
        </header>

        <div id="profiles-list" class="hidden">
            <!-- Content will be rendered here -->
        </div>

        <div id="loading-message" class="text-center py-12 text-lg text-gray-600 font-semibold">
            Σύνδεση επιτυχής. Αναμονή δεδομένων...
        </div>

        <!-- Custom Modal for Alerts and Prompts (replaces alert() and prompt()) -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center hidden">
            <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-md">
                <h3 id="modal-title" class="text-xl font-bold mb-4 text-blue-600"></h3>
                <p id="modal-message" class="text-gray-700 mb-6"></p>
                <input type="text" id="modal-input" class="candidate-input w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 hidden" placeholder="Εισάγετε το όνομα του νέου υποψηφίου">
                
                <div class="flex justify-end space-x-3 mt-4">
                    <button id="modal-cancel-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition hidden">Άκυρο</button>
                    <button id="modal-ok-btn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition">OK</button>
                </div>
            </div>
        </div>
    </div>
    
    <script type="module">
        // Global variables for Firebase access
        let app;
        let db;
        let auth;
        let userId = 'default-user'; // Placeholder, updated after auth
        let isDataLoaded = false;
        
        // --- MANDATORY FIREBASE GLOBALS ---
        const appId = 'github-standalone-app';
        const initialAuthToken = undefined;

        // 2. FIREBASE CONFIGURATION (ΧΡΗΣΙΜΟΠΟΙΟΥΜΕ ΤΑ ΚΛΕΙΔΙΑ ΤΟΥ ΧΡΗΣΤΗ)
        const firebaseConfig = {
            apiKey: "AIzaSyAXFlEK9ehNqUSbHE2DFGt4tE0uVll7WQs",
            authDomain: "team-tracker-c123a.firebaseapp.com",
            databaseURL: "https://team-tracker-c123a-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "team-tracker-c123a",
            storageBucket: "team-tracker-c123a.firebasestorage.app",
            messagingSenderId: "201123283369",
            appId: "1:201123283369:web:ae0c28d6d8a637aa0404b8",
            measurementId: "G-5EHRR21L4W"
        };
        
        // ----------------------------------------------------
        // 1. Firebase Imports (Modern Module Syntax)
        // ----------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";
        
        // Use Realtime Database Pathing
        const publicPath = `/recruitment-profiles`;
        
        // Default Data Structure (Includes 7 Profiles)
        const defaultProfilesData = {
            'frontend': { title: 'Frontend Developer', targetCount: '1', candidates: [
                { name: 'Αραμπαντζής', comment: 'Καλό προφίλ, ενδιαφέρον σε React.', status: 'Accepted' },
                { name: 'Κυρώσης', comment: 'Αδύναμο portfolio. Χρειάζεται βελτίωση.', status: 'Rejected' }
            ]},
            'backend': { title: 'Backend Developer', targetCount: '2', candidates: [
                { name: 'Γερουτσκής', comment: 'Εμπειρία σε Java/Spring.', status: 'NoStatus' },
                { name: 'Τάτσης', comment: 'Python/Django, εξαιρετικές συστάσεις.', status: 'Interviewing' }
            ]},
            'teamlead': { title: 'SW Team Lead', targetCount: '1', candidates: [
                { name: 'Χρυσοδούλου', comment: 'Πολύ έμπειρος σε διαχείριση ομάδας.', status: 'Accepted' },
                { name: 'Δήμου', comment: 'Ισχυρό τεχνικό υπόβαθρο.', status: 'Rejected' }
            ]},
            'architect': { title: 'System Architect', targetCount: '1', candidates: [
                { name: 'Μπαμπλάδιμος', comment: 'Πολύ καλή συνολική εικόνα συστημάτων.', status: 'NoStatus' }
            ]},
            'devops': { title: 'DevOps Engineer', targetCount: '1', candidates: [
                { name: 'Τριανταφυλλόπουλος', comment: 'Ισχυρή εμπειρία σε Kubernetes.', status: 'NoStatus' }
            ]},
            'other': { title: 'Other Profiles', targetCount: '1', candidates: [
                { name: 'Πρόγιας', comment: 'Διαθέσιμος για άλλα projects.', status: 'NoStatus' },
                { name: 'Βενιανάκης', comment: '', status: 'NoStatus' }
            ]},
            'aiengineers': { title: 'AI Engineers', targetCount: '2', candidates: [], status: 'NoStatus' } // 7ο Προφίλ
        };

        let profilesData = {};

        const loadingMessage = document.getElementById('loading-message');
        const profilesList = document.getElementById('profiles-list');
        const authStatusElement = document.getElementById('auth-status');
        
        // ----------------------------------------------------
        // 2. Custom Modal Functions (Replaces alert() and prompt())
        // ----------------------------------------------------
        const modalContainer = document.getElementById('modal-container');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalInput = document.getElementById('modal-input');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        /**
         * Custom alert/message box function.
         */
        function showMessageBox(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');
            
            modalContainer.classList.remove('hidden');
            
            return new Promise(resolve => {
                modalOkBtn.onclick = () => {
                    modalContainer.classList.add('hidden');
                    resolve(true);
                };
            });
        }

        /**
         * Custom prompt for input.
         * @returns {Promise<string|null>} The input value or null if cancelled.
         */
        function promptForCandidateName(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalInput.value = '';
            modalInput.classList.remove('hidden');
            modalCancelBtn.classList.remove('hidden');
            
            modalContainer.classList.remove('hidden');
            modalInput.focus();

            return new Promise(resolve => {
                const handleOk = () => {
                    modalContainer.classList.add('hidden');
                    resolve(modalInput.value);
                    cleanup();
                };
                const handleCancel = () => {
                    modalContainer.classList.add('hidden');
                    resolve(null);
                    cleanup();
                };
                
                modalOkBtn.onclick = handleOk;
                modalCancelBtn.onclick = handleCancel;
                
                const cleanup = () => {
                    modalOkBtn.onclick = null;
                    modalCancelBtn.onclick = null;
                };
            });
        }
        
        // ----------------------------------------------------
        // 3. Firebase Initialization and Authentication
        // ----------------------------------------------------

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                db = getDatabase(app); 
                auth = getAuth(app);
                
                // Sign in anonymously and set up listener
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        authStatusElement.textContent = `Σύνδεση: ${userId.substring(0, 8)}... (Δημόσια Δεδομένα)`;
                        loadData(); 
                    } else {
                        // Attempt anonymous sign-in only if not already authenticated
                        try {
                            await signInAnonymously(auth);
                        } catch(e) {
                             console.error("Anonymous Sign-in Failed:", e);
                             authStatusElement.textContent = 'ΣΦΑΛΜΑ: Αποτυχία ανώνυμης σύνδεσης.';
                        }
                    }
                });
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                authStatusElement.textContent = `ΣΦΑΛΜΑ: Αδυναμία σύνδεσης Firebase. Ελέγξτε τα κλειδιά σας. (${error.code})`;
            }
        }
        
        // ----------------------------------------------------
        // 4. Data Operations
        // ----------------------------------------------------

        /**
         * Initializes the RTDB with default data if the path is empty.
         */
        async function initializeWithDefaultData() {
            console.log("Initializing with default data...");
             try {
                // Ensure all 7 profiles are written on initialization
                await set(ref(db, publicPath), defaultProfilesData);
                console.log("Default data written successfully.");
            } catch (error) {
                console.error("Error writing default data:", error);
                showMessageBox('Σφάλμα', 'Αποτυχία εγγραφής προεπιλεγμένων δεδομένων στη βάση δεδοτήνων.');
            }
        }
        
        /**
         * Sets up the real-time listener for the data using onValue (RTDB).
         */
        function loadData() {
            const dbRef = ref(db, publicPath);
            
            onValue(dbRef, (snapshot) => {
                // This fires BOTH when loading (first time) AND when data changes (second time)
                
                if (snapshot.exists()) {
                    profilesData = snapshot.val();
                    console.log("Data loaded successfully from RTDB.");
                    
                    // On successful load (second time, data exists): Hide loader and show list
                    loadingMessage.classList.add('hidden'); 
                    isDataLoaded = true;
                    profilesList.classList.remove('hidden');
                    
                    renderApp(); // RENDER THE DATA

                } else {
                    console.log("No data found, initializing...");
                    // On initial load (first time, data doesn't exist): Write defaults
                    initializeWithDefaultData(); 
                    // No return here, the write operation above will trigger the listener again!
                }
                
            }, (error) => {
                console.error("RTDB Listener Error:", error);
                showMessageBox('Σφάλμα Δεδομένων', `Αδυναμία φόρτωσης δεδομένων: ${error.message}. Ελέγξτε τους κανόνες (rules).`);
            });
        }

        /**
         * Saves the current profilesData object to the Realtime Database.
         */
        function saveData() {
            if (!db || !isDataLoaded) {
                 console.warn("Database not ready or data not loaded yet. Skipping save.");
                 return;
            }
            // Use set for overwriting the whole dataset on change (simplest approach)
            set(ref(db, publicPath), profilesData)
                .then(() => console.log("Data saved successfully."))
                .catch(error => {
                    console.error("Error saving data:", error);
                    showMessageBox('Σφάλμα Αποθήκευσης', `Αδυναμία αποθήκευσης: ${error.message}`);
                });
        }
        
        // ----------------------------------------------------
        // 5. Rendering Functions (Full implementation)
        // ----------------------------------------------------

        function renderApp() {
            profilesList.innerHTML = ''; // Clear previous content
            
            const profileKeys = Object.keys(profilesData);
            profileKeys.forEach(profileKey => {
                profilesList.appendChild(createProfileContainer(profileKey, profilesData[profileKey]));
            });
        }
        
        // 9. Λογική Κλειδώματος
        function checkProfileLock(profileKey, container) {
            const profile = profilesData[profileKey];
            const acceptedCount = profile.candidates.filter(c => c.status === 'Accepted').length;
            const target = parseInt(profile.targetCount, 10);
            const isLocked = acceptedCount >= target && target > 0;
            
            // Ενημέρωση κλειδώματος του container
            container.classList.toggle('bg-red-50', isLocked);
            container.classList.toggle('border-red-300', isLocked);
            container.classList.toggle('bg-green-50', !isLocked);
            container.classList.toggle('border-green-300', !isLocked);
            
            // Ενημέρωση του target display
            const targetSpan = container.querySelector('.target-display');
            if (targetSpan) {
                 targetSpan.querySelector('span').textContent = ` (${acceptedCount}/${target} Προσληφθέντες)`;
            }

            // Επιστρέφουμε την κατάσταση κλειδώματος
            return isLocked;
        }

        // 10. Δημιουργία Γραμμής Υποψηφίου
        function createCandidateRow(profileKey, candidate, index, isLocked) {
            const row = document.createElement('div');
            // Responsive Grid: 12 cols on mobile, splits to 4/3/3/2 on desktop
            row.className = `candidate-row grid grid-cols-12 gap-3 items-center p-3 border-l-4 rounded-lg hover:bg-gray-50 transition ${isLocked && candidate.status === 'Accepted' ? 'border-green-600' : 'border-gray-300'}`;
            
            // Name (Col 1-4)
            // Added global handler prefix to onblur event
            row.innerHTML += `<div class="col-span-12 sm:col-span-4 font-medium text-gray-800 truncate" contenteditable="true" onblur="window.handleNameChange('${profileKey}', ${index}, this.textContent, this)">${candidate.name}</div>`;
            
            // Status (Col 5-7)
            row.innerHTML += `
                <div class="col-span-6 sm:col-span-3">
                    <select data-profile-key="${profileKey}" data-candidate-index="${index}"
                        class="status-select w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm bg-white"
                        onchange="window.handleStatusChange(this)" ${isLocked && candidate.status !== 'Accepted' ? 'disabled' : ''}>
                        <option value="NoStatus" ${candidate.status === 'NoStatus' ? 'selected' : ''}>Αναμονή</option>
                        <option value="Interviewing" ${candidate.status === 'Interviewing' ? 'selected' : ''}>Σε Συνέντευξη</option>
                        <option value="Accepted" ${candidate.status === 'Accepted' ? 'selected' : ''}>Προσλήφθηκε</option>
                        <option value="Rejected" ${candidate.status === 'Rejected' ? 'selected' : ''}>Απορρίφθηκε</option>
                    </select>
                </div>`;

            // Comment (Col 8-10)
            row.innerHTML += `
                <div class="col-span-6 sm:col-span-3">
                    <input type="text" value="${candidate.comment}" data-profile-key="${profileKey}" data-candidate-index="${index}"
                        class="candidate-input w-full p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm transition"
                        placeholder="Σημειώσεις"
                        onchange="window.handleCommentChange(this.dataset.profileKey, this.dataset.candidateIndex, this.value)">
                </div>`;
            
            // Delete Button (Col 11-12)
            row.innerHTML += `
                <div class="col-span-12 sm:col-span-2 flex justify-end">
                    <button onclick="window.handleDeleteCandidate('${profileKey}', ${index})"
                        class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition text-xs font-semibold">
                        Διαγραφή
                    </button>
                </div>`;

            return row;
        }

        // 11. Δημιουργία Προφίλ Container
        function createProfileContainer(profileKey, profile) {
            const container = document.createElement('div');
            container.className = `profile-container bg-white border border-gray-200 rounded-xl shadow-lg p-4 md:p-6 mb-8`;
            
            // 9. Λογική Κλειδώματος
            const acceptedCount = profile.candidates.filter(c => c.status === 'Accepted').length;
            const target = parseInt(profile.targetCount, 10);
            const isLocked = acceptedCount >= target && target > 0;
            
            // Apply lock classes immediately
            const lockClass = isLocked ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300';
            const progressColor = acceptedCount >= target ? 'bg-green-500' : (acceptedCount > 0 ? 'bg-yellow-500' : 'bg-blue-500');
            const progressWidth = target > 0 ? (acceptedCount / target) * 100 : 0;
            
            container.innerHTML = `
                <div class="profile-header flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-3 mb-4">
                    <h2 class="profile-title text-2xl font-bold text-gray-800">${profile.title}</h2>
                    <div class="flex items-center space-x-4 mt-2 sm:mt-0">
                        <label class="text-sm font-medium text-gray-600 flex items-center">
                            Στόχος:
                            <input type="number" value="${target}" min="0" data-profile-key="${profileKey}"
                                class="target-input w-16 ml-2 p-1 border ${lockClass} rounded-lg text-center font-semibold focus:outline-none focus:ring-2 focus:ring-blue-500 transition" 
                                onchange="window.handleTargetChange(this)">
                        </label>
                        <div class="text-sm font-medium text-gray-700 w-32">
                            <span class="font-bold text-lg text-blue-600">${acceptedCount}</span> / ${target} Προσλήψεις
                            <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                                <div class="${progressColor} h-2.5 rounded-full" style="width: ${Math.min(100, progressWidth)}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mb-4 p-2 ${lockClass} rounded-lg">
                    <p class="text-sm font-semibold text-gray-700">Λίστα Υποψηφίων:</p>
                    <button onclick="window.handleAddCandidate('${profileKey}')"
                        class="px-4 py-2 text-sm font-semibold rounded-lg shadow-md transition
                        ${isLocked ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-green-500 text-white hover:bg-green-600'}"
                        ${isLocked ? 'disabled' : ''}>
                        + Νέος Υποψήφιος
                    </button>
                </div>
                <div id="list-${profileKey}" class="list-container space-y-3">
                    <!-- Candidate Rows -->
                </div>
            `;
            
            const listDiv = container.querySelector(`#list-${profileKey}`);
            profile.candidates.forEach((candidate, index) => {
                const row = createCandidateRow(profileKey, candidate, index, isLocked);
                listDiv.appendChild(row);
            });
            
            return container;
        }

        // 13. Χειρισμός Αλλαγής Status
        window.handleStatusChange = function(element) {
            const profileKey = element.dataset.profileKey;
            const candidateIndex = parseInt(element.dataset.candidateIndex, 10);
            const newStatus = element.value;
            
            profilesData[profileKey].candidates[candidateIndex].status = newStatus;
            saveData();
        }

        // 14. Χειρισμός Αλλαγής Target
        window.handleTargetChange = function(element) {
            const profileKey = element.dataset.profileKey;
            const newTarget = parseInt(element.value, 10);
            
            profilesData[profileKey].targetCount = newTarget.toString();
            saveData(); 
        }

        // 15. Χειρισμός Αλλαγής Ονόματος
        window.handleNameChange = function(profileKey, candidateIndex, newName, element) {
            const trimmedName = newName.trim();
            const originalName = profilesData[profileKey].candidates[parseInt(candidateIndex, 10)].name;

            if (trimmedName && trimmedName !== originalName) {
                profilesData[profileKey].candidates[parseInt(candidateIndex, 10)].name = trimmedName;
                saveData(); 
            } else if (!trimmedName) {
                element.textContent = originalName;
            }
        }
        
        // 16. Χειρισμός Προσθήκης Υποψηφίου
        window.handleAddCandidate = async function(profileKey) {
            const profile = profilesData[profileKey];
            const acceptedCount = profile.candidates.filter(c => c.status === 'Accepted').length;
            const target = parseInt(profile.targetCount, 10) || 0;
            
            if (acceptedCount >= target && target > 0) {
                 await showMessageBox(
                    'Όριο Προσλήψεων', 
                    'Η κατηγορία είναι κλειδωμένη (ο στόχος προσλήψεων επιτεύχθηκε). Αυξήστε τον προβλεπόμενο αριθμό για να προσθέσετε νέους υποψηφίους.'
                 );
                 return;
            }

            const candidateName = await promptForCandidateName(
                'Νέος Υποψήφιος', 
                'Εισάγετε το όνομα του νέου υποψηφίου:'
            );
            
            if (candidateName !== null) {
                const newCandidate = {
                    name: (candidateName.trim() || 'Νέος Υποψήφιος (Απρόσωπο)'),
                    comment: '',
                    status: 'NoStatus'
                };
                
                profilesData[profileKey].candidates.push(newCandidate);
                saveData(); 
            }
        }
        
        // 17. Χειρισμός Αλλαγής Σημειώσεων
        window.handleCommentChange = function(profileKey, candidateIndex, newComment) {
            profilesData[profileKey].candidates[parseInt(candidateIndex, 10)].comment = newComment;
            saveData();
        }

        // 18. Χειρισμός Διαγραφής Υποψηφίου
        window.handleDeleteCandidate = function(profileKey, candidateIndex) {
            profilesData[profileKey].candidates.splice(candidateIndex, 1);
            saveData();
        }

        // 19. Execution
        window.onload = function() {
            initFirebase();
        }
        
    </script>
</body>
</html>
