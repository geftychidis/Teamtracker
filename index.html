<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Παρακολούθηση Προφίλ Υποψηφίων</title>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif; background:#f9fafb; }
    .status-select { border:1px solid #d1d5db; background:#fff; }
    .row { border-left:4px solid #e5e7eb; }
  </style>
</head>
<body class="p-6">
  <div class="max-w-6xl mx-auto">
    <header class="mb-6 border-b pb-4 border-blue-200">
      <h1 class="text-3xl font-extrabold text-blue-700">Παρακολούθηση Προφίλ Υποψηφίων</h1>
      <p id="auth-status" class="text-sm text-gray-500 mt-1">Αρχικοποίηση…</p>
    </header>

    <div id="banner" class="hidden mb-4 p-3 rounded text-sm"></div>

    <div id="loading" class="text-center py-10 text-lg text-gray-600">Σύνδεση επιτυχής. Αναμονή δεδομένων…</div>
    <div id="list" class="hidden"></div>
  </div>

  <script>
    // ===== Firebase config (project: team-tracker-c123a) =====
    const firebaseConfig = {
      apiKey: "AIzaSyAXFlEK9ehNqUSbHE2DFGt4tE0uVll7WQs",
      authDomain: "team-tracker-c123a.firebaseapp.com",
      databaseURL: "https://team-tracker-c123a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "team-tracker-c123a",
      storageBucket: "team-tracker-c123a.appspot.com",
      messagingSenderId: "201123283369",
      appId: "1:201123283369:web:ae0c28d6d8a637aa0404b8"
    };
    const PATH = '/recruitment-profiles';

    // ===== UI refs =====
    const authStatus = document.getElementById('auth-status');
    const loadingEl  = document.getElementById('loading');
    const listEl     = document.getElementById('list');
    const banner     = document.getElementById('banner');

    function showBanner(msg, kind='info'){
      const classes = {
        info:  'bg-blue-50 text-blue-800 border border-blue-200',
        warn:  'bg-yellow-50 text-yellow-800 border border-yellow-200',
        error: 'bg-red-50 text-red-800 border border-red-200',
      };
      banner.textContent = msg;
      banner.className = `mb-4 p-3 rounded text-sm ${classes[kind]||classes.info}`;
      banner.classList.remove('hidden');
    }

    let app, db, auth, profilesData = {};

    // ===== init =====
    (function init(){
      app = firebase.initializeApp(firebaseConfig);
      db  = app.database();
      auth= app.auth();

      auth.onAuthStateChanged(async (user)=>{
        if(user){
          authStatus.textContent = `Σύνδεση: ${user.uid.substring(0,8)}…`;
          attachDB();
        }else{
          try { await auth.signInAnonymously(); }
          catch(e){
            authStatus.textContent = `ΣΦΑΛΜΑ auth: ${e.code||e.message}`;
            showBanner('Απέτυχε η ανώνυμη σύνδεση. Έλεγξε Authorized domains & Sign-in method.', 'error');
          }
        }
      });
    })();

    // ===== DB listener =====
    function attachDB(){
      db.ref(PATH).on('value', (snap)=>{
        if(!snap.exists()){
          loadingEl.textContent = 'Δεν βρέθηκαν δεδομένα στο /recruitment-profiles.';
          return;
        }
        profilesData = snap.val();
        render();
      }, (err)=>{
        showBanner(`Σφάλμα ανάγνωσης DB: ${err.message}`, 'error');
      });
    }

    // ===== Render =====
    function render(){
      // hide loader, show list
      loadingEl.classList.add('hidden');
      listEl.classList.remove('hidden');

      listEl.innerHTML = '';
      Object.keys(profilesData).forEach(key=>{
        listEl.appendChild(renderProfile(key, profilesData[key]));
      });
    }

    function renderProfile(key, profile){
      const candidates = Array.isArray(profile.candidates) ? profile.candidates : [];
      const accepted = candidates.filter(c=>c.status==='Accepted').length;
      const target   = parseInt(profile.targetCount,10) || 0;
      const locked   = target>0 && accepted>=target;
      const lockClass = locked ? 'bg-red-50 border-red-300' : 'bg-green-50 border-green-300';

      const card = document.createElement('div');
      card.className = 'bg-white border border-gray-200 rounded-xl shadow p-4 mb-6';

      card.innerHTML = `
        <div class="flex justify-between items-center border-b pb-2 mb-3">
          <h2 class="text-xl font-bold text-gray-800">${profile.title}</h2>
          <div class="text-sm text-gray-700">
            <span class="font-semibold text-blue-600">${accepted}</span> / ${target} Προσλήψεις
          </div>
        </div>
        <div class="flex justify-between items-center mb-3 ${lockClass} rounded p-2">
          <label class="text-sm font-medium text-gray-700 flex items-center">
            Στόχος:
            <input type="number" value="${target}" min="0" data-key="${key}"
                   class="w-20 ml-2 p-1 border rounded text-center"
                   onchange="handleTarget(this)">
          </label>
          <button class="px-3 py-1 text-sm font-semibold rounded ${locked ? 'bg-gray-400 text-gray-700 cursor-not-allowed' : 'bg-green-600 text-white hover:bg-green-700'}"
                  onclick="handleAdd('${key}')" ${locked?'disabled':''}>
            + Νέος Υποψήφιος
          </button>
        </div>
        <div id="rows-${key}" class="space-y-2"></div>
      `;

      const rows = card.querySelector(`#rows-${key}`);
      candidates.forEach((c,i)=> rows.appendChild(renderRow(key,c,i,locked)));
      return card;
    }

    function renderRow(key, c, i, locked){
      const row = document.createElement('div');
      row.className = 'row grid grid-cols-12 gap-2 items-center p-2 rounded bg-white';
      row.innerHTML = `
        <div class="col-span-4 font-medium text-gray-800" contenteditable="true"
             onblur="handleName('${key}',${i},this.textContent,this)">${c.name||''}</div>

        <div class="col-span-3">
          <select class="status-select w-full p-1 rounded text-sm"
                  data-key="${key}" data-index="${i}" onchange="handleStatus(this)">
            <option value="NoStatus" ${c.status==='NoStatus'?'selected':''}>Αναμονή</option>
            <option value="Interviewing" ${c.status==='Interviewing'?'selected':''}>Σε Συνέντευξη</option>
            <option value="Accepted" ${c.status==='Accepted'?'selected':''}>Προσλήφθηκε</option>
            <option value="Rejected" ${c.status==='Rejected'?'selected':''}>Απορρίφθηκε</option>
          </select>
        </div>

        <div class="col-span-4">
          <input class="w-full p-1 border rounded text-sm" type="text"
                 value="${c.comment||''}" onchange="handleComment('${key}',${i},this.value)">
        </div>

        <div class="col-span-1 text-right">
          <button class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200"
                  onclick="handleDelete('${key}',${i})">✕</button>
        </div>
      `;
      if (locked && c.status!=='Accepted') {
        row.querySelector('select').disabled = true;
      }
      return row;
    }

    // ===== Handlers (save to RTDB) =====
    function save(){ return db.ref(PATH).set(profilesData); }

    function handleStatus(el){
      const k = el.dataset.key, i = parseInt(el.dataset.index,10);
      profilesData[k].candidates[i].status = el.value;
      save().catch(e=>showBanner(`Αδυναμία αποθήκευσης: ${e.message}`,'error'));
    }
    function handleComment(k,i,v){
      profilesData[k].candidates[i].comment = v;
      save().catch(e=>showBanner(`Αδυναμία αποθήκευσης: ${e.message}`,'error'));
    }
    function handleName(k,i,text,el){
      const n = (text||'').trim();
      if(!n){ el.textContent = profilesData[k].candidates[i].name; return; }
      profilesData[k].candidates[i].name = n;
      save().catch(e=>showBanner(`Αδυναμία αποθήκευσης: ${e.message}`,'error'));
    }
    function handleTarget(el){
      const k = el.dataset.key;
      profilesData[k].targetCount = String(parseInt(el.value,10)||0);
      save().catch(e=>showBanner(`Αδυναμία αποθήκευσης: ${e.message}`,'error'));
    }
    function handleAdd(k){
      const name = prompt('Όνομα νέου υποψηφίου:','');
      if (name === null) return;
      profilesData[k].candidates.push({ name: name.trim()||'Νέος Υποψήφιος', comment:'', status:'NoStatus' });
      save().catch(e=>showBanner(`Αδυναμία αποθήκευσης: ${e.message}`,'error'));
    }
    function handleDelete(k,i){
      profilesData[k].candidates.splice(i,1);
      save().catch(e=>showBanner(`Αδυναμία αποθήκευσης: ${e.message}`,'error'));
    }

    // expose (inline handlers)
    window.handleStatus = handleStatus;
    window.handleComment= handleComment;
    window.handleName   = handleName;
    window.handleTarget = handleTarget;
    window.handleAdd    = handleAdd;
    window.handleDelete = handleDelete;
  </script>
</body>
</html>
