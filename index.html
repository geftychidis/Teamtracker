<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Recruitment Tracker — Diagnostics</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6">
  <div class="max-w-5xl mx-auto space-y-4">
    <h1 class="text-3xl font-extrabold text-blue-700">Παρακολούθηση Προφίλ Υποψηφίων</h1>
    <div class="p-4 bg-white rounded-lg shadow">
      <h2 class="font-semibold text-gray-800 mb-2">Διαγνωστικά</h2>
      <pre id="log" class="text-sm bg-gray-100 p-3 rounded overflow-auto h-60"></pre>
    </div>

    <div id="banner" class="hidden p-3 rounded text-sm"></div>
    <div id="app" class="hidden p-4 bg-white rounded-lg shadow">
      <p id="auth-status" class="text-sm text-gray-600 mb-2">Auth: …</p>
      <p id="db-status" class="text-sm text-gray-600 mb-4">DB: …</p>
      <div id="content" class="text-gray-800">OK, είμαστε συνδεδεμένοι. Τα δεδομένα θα φανούν εδώ.</div>
    </div>
  </div>

<script>
const logEl = document.getElementById('log');
function log(...args){ const line = args.map(a => typeof a==='object'? JSON.stringify(a): String(a)).join(' '); logEl.textContent += line + '\n'; console.log(...args); }
function setBanner(text, cls){ const b=document.getElementById('banner'); b.textContent=text; b.className=`p-3 rounded text-sm ${cls}`; b.classList.remove('hidden'); }

const firebaseConfig = {
  apiKey: "AIzaSyAXFlEK9ehNqUSbHE2DFGt4tE0uVll7WQs",
  authDomain: "team-tracker-c123a.firebaseapp.com",
  databaseURL: "https://team-tracker-c123a-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "team-tracker-c123a",
  storageBucket: "team-tracker-c123a.appspot.com",
  messagingSenderId: "201123283369",
  appId: "1:201123283369:web:ae0c28d6d8a637aa0404b8"
};

const defaultData = {
  frontend:{title:'Frontend Developer',targetCount:'1',candidates:[
    {name:'Αραμπαντζής',comment:'Καλό προφίλ, ενδιαφέρον σε React.',status:'Accepted'},
    {name:'Κυρώσης',comment:'Αδύναμο portfolio.',status:'Rejected'}
  ]},
  backend:{title:'Backend Developer',targetCount:'2',candidates:[
    {name:'Γερουτσκής',comment:'Java/Spring',status:'NoStatus'},
    {name:'Τάτσης',comment:'Python/Django',status:'Interviewing'}
  ]},
  teamlead:{title:'SW Team Lead',targetCount:'1',candidates:[
    {name:'Χρυσοδούλου',comment:'Έμπειρος',status:'Accepted'}
  ]},
  architect:{title:'System Architect',targetCount:'1',candidates:[
    {name:'Μπαμπλάδιμος',comment:'Καλή εικόνα',status:'NoStatus'}
  ]},
  devops:{title:'DevOps Engineer',targetCount:'1',candidates:[
    {name:'Τριανταφυλλόπουλος',comment:'Kubernetes',status:'NoStatus'}
  ]},
  other:{title:'Other Profiles',targetCount:'1',candidates:[
    {name:'Πρόγιας',comment:'Διαθέσιμος',status:'NoStatus'}
  ]},
  aiengineers:{title:'AI Engineers',targetCount:'2',candidates:[]}
};

const AUTH = { ok:false, err:null };
const DB   = { ok:false, err:null };
const PATH = '/recruitment-profiles';

let app, db, auth;
let profilesData = null;

(async function main(){
  try {
    app = firebase.initializeApp(firebaseConfig);
    db  = app.database();
    auth= app.auth();
    log('Firebase initialized.');
  } catch(e){
    log('Init error:', e);
    setBanner('ΣΦΑΛΜΑ Firebase init: '+(e.message||e), 'bg-red-100 text-red-800 border border-red-300');
    return;
  }

  auth.onAuthStateChanged(async (user)=>{
    if(user){
      AUTH.ok = true; AUTH.err = null;
      document.getElementById('auth-status').textContent = 'Auth: OK ('+user.uid.substring(0,8)+'…)';
      log('Auth OK, uid:', user.uid);
      await startDB();
    }else{
      try{
        log('Signing in anonymously…');
        await auth.signInAnonymously();
      }catch(e){
        AUTH.ok = false; AUTH.err = e;
        log('Anonymous sign-in failed:', e);
        setBanner('ΣΦΑΛΜΑ ανώνυμης σύνδεσης: '+(e.code||e.message), 'bg-red-100 text-red-800 border border-red-300');
      }
    }
  });
})();

async function startDB(){
  document.getElementById('app').classList.remove('hidden');

  // Health check: .info/connected
  db.ref('.info/connected').on('value', snap=>{
    log('RTDB .info/connected =', snap.val());
  });

  // Try to read the path
  db.ref(PATH).once('value').then(async snap=>{
    if(snap.exists()){
      DB.ok = true; DB.err = null;
      profilesData = snap.val();
      document.getElementById('db-status').textContent='DB: OK (data exists)';
      log('Data exists at', PATH);
      attachLiveListener();
    }else{
      log('No data at path, attempting to seed defaults…');
      try{
        await db.ref(PATH).set(defaultData);
        document.getElementById('db-status').textContent='DB: OK (seeded defaults)';
        attachLiveListener();
      }catch(e){
        DB.ok = false; DB.err = e;
        document.getElementById('db-status').textContent='DB: ERROR seeding';
        log('Seed write failed:', e);
        setBanner('DB write αποτυχία: '+(e.code||e.message)+' — Έλεγξε Rules & ότι υπάρχει Realtime Database instance.', 'bg-yellow-100 text-yellow-800 border border-yellow-300');
      }
    }
  }).catch(e=>{
    DB.ok=false; DB.err=e;
    document.getElementById('db-status').textContent='DB: ERROR read';
    log('Initial read failed:', e);
    setBanner('DB read αποτυχία: '+(e.code||e.message)+' — Συνήθως είναι Rules ή λάθος databaseURL.', 'bg-yellow-100 text-yellow-800 border border-yellow-300');
  });
}

function attachLiveListener(){
  db.ref(PATH).on('value', snap=>{
    log('Live update fired. exists=', snap.exists());
    if(snap.exists()){
      profilesData = snap.val();
      document.getElementById('content').textContent = 'Φορτώθηκαν '+Object.keys(profilesData).length+' προφίλ.';
    }
  }, e=>{
    log('Live listener error:', e);
    setBanner('Listener error: '+(e.code||e.message), 'bg-yellow-100 text-yellow-800 border border-yellow-300');
  });
}
</script>
</body>
</html>
